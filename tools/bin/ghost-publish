#!/usr/bin/env bash
set -euo pipefail

# Publish to Ghost CMS. Accepts title + HTML body (string or file).
#
# Usage:
#   ghost-publish "Title" "<p>Body HTML</p>"
#   ghost-publish "Title" --file /tmp/article.html
#   ghost-publish "Title" --file /tmp/article.html --tags "ai,agents" --status published
#   echo "<p>Body</p>" | ghost-publish "Title" --stdin
#
# Requires: GHOST_URL, GHOST_ADMIN_API_KEY in environment or .env

source "$(dirname "${BASH_SOURCE[0]}")/_common.sh"

TITLE="${1:?Usage: ghost-publish \"Title\" \"<html>\" [--tags t1,t2] [--status draft|published]}"
shift

HTML=""
TAGS=""
AUTHOR=""
STATUS="draft"

while [[ $# -gt 0 ]]; do
    case "$1" in
        --file)   HTML="$(cat "$2")"; shift 2 ;;
        --stdin)  HTML="$(cat -)"; shift ;;
        --tags)   TAGS="$2"; shift 2 ;;
        --author) AUTHOR="$2"; shift 2 ;;
        --status) STATUS="$2"; shift 2 ;;
        *)        HTML="$1"; shift ;;
    esac
done

if [ -z "$HTML" ]; then
    echo "ERROR: No HTML body provided" >&2
    exit 1
fi

CMD="create-draft"
[ "$STATUS" = "published" ] && CMD="create-post"

exec "$PYTHON" "$CLIENT" "$CMD" "$TITLE" "$HTML" "$AUTHOR" "$TAGS"
